#!/bin/sh

# Resource Impl: http://concourse.ci/implementing-resources.html#out:-update-a-resource.
set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

source=${1}

if [ -z "${source}" ]; then
  echo "usage: ${0} </full/path/to/dir>"
  exit 1
fi
#######################################

# parse incoming config data
payload=$(cat)
bucket=$(echo "${payload}" | jq -er '.source.bucket')
endpoint_url="$(echo "${payload}" | jq -er '.source.endpoint // ""')"
region="$(echo "${payload}" | jq -er '.source.region // "us-east-1"')"
use_v4="$(echo "${payload}" | jq -er '.source.use_v4 // ""')"
path=$(echo "${payload}" | jq -er '.source.path // ""')
suffix=$(echo "${payload}" | jq -er '.source.suffix // ""')
encryption_key="$(echo "${payload}" | jq -er '.source.encryption_key // ""')"

# export for `aws` cli
AWS_ACCESS_KEY_ID=$(echo "${payload}" | jq -er '.source.access_key_id')
AWS_SECRET_ACCESS_KEY=$(echo "${payload}" | jq -er '.source.secret_access_key')

# Due to precedence rules, must be unset to support AWS IAM Roles.
if [ -n "${AWS_ACCESS_KEY_ID}" ] && [ -n "${AWS_SECRET_ACCESS_KEY}" ]; then
  export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
  export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
fi

if [ -n "${endpoint_url}" ]; then
  endpoint_opt="--endpoint-url=${endpoint_url}"
fi

export AWS_DEFAULT_REGION="${region}"
if [ "${use_v4}" = "true" ];then
  aws configure set default.s3.signature_version s3v4
fi

if [ ! "${encryption_key}" = "" ];then
  echo "Encrypting with GnuPG..."
  find "${source}/${path}" -type f -name "*${suffix}" -exec \
    gpg --yes --batch --passphrase="${encryption_key}" -c {} \;
  with_enc=".gpg"
fi

echo "Uploading to S3..."
options="--exclude='*' --include='*${suffix}${with_enc}' --delete"
# We don't want options encapsulated in quotes as they are space-separated switches
# shellcheck disable=SC2086
eval aws s3 sync "${source}/${path}" "s3://${bucket}/${path}" ${endpoint_opt} ${options}
echo "...done."

# We don't want options encapsulated in quotes as they are space-separated switches
# shellcheck disable=SC2086
timestamps=$(aws s3api list-objects ${endpoint_opt} --bucket "${bucket}" --prefix "${path}" --query "Contents[?ends_with(Key, \`${suffix}.gpg\`)].{LastModified: LastModified}")
recent="$(echo "${timestamps}" | jq -er 'max_by(.LastModified)' | jq -e 'select (.!=null)')"

[ ! "${recent}" = "" ] || recent='{}'

jq -en "{
  version: ${recent}
}" >&3
